<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blog • Fusion</title>
  <meta name="description" content="Latest updates, tips, and news from Fusion." />
  <link rel="icon" href="/favicon.ico" />
  <link rel="canonical" href="/blog.html" />

  <!--
    NOTE: If your project already has a global stylesheet, you can remove
    the scoped styles below. They are scoped under #blog-page to avoid conflicts.
  -->
  <script src="js/jquery.min.js"></script>
  <script src="js/menu/menu.js"></script>
  <script src="layout/script.js"></script>
</head>
<body id="blog-page">
  <!-- Replace this header with your site's existing navbar markup if you have one -->
  <div id="commonNav"></div>

  <main class="container">
    <section class="hero" aria-labelledby="blog-heading">
      <h1 id="blog-heading">Blog</h1>
      <p>Updates, tutorials, and announcements. New posts appear automatically from <code>posts.json</code>.</p>
      <div class="controls" aria-label="Filters and search">
        <input id="search" class="control" type="search" placeholder="Search posts…" aria-label="Search posts" />
        <select id="filterTag" class="control" aria-label="Filter by tag">
          <option value="">All tags</option>
        </select>
      </div>
    </section>

    <section aria-live="polite">
      <div id="grid" class="grid" role="list"></div>
      <template id="card-tpl">
        <article class="card" role="listitem">
          <img class="thumb" alt="" />
          <div class="content">
            <div class="meta">
              <time class="date" datetime=""></time>
              <span class="dot">•</span>
              <span class="read"></span>
            </div>
            <h2 class="title"></h2>
            <p class="excerpt"></p>
            <div class="tags"></div>
          </div>
          <div class="read-more">
            <a class="open-modal" href="#">Read more →</a>
          </div>
        </article>
      </template>
    </section>
  </main>

  <footer id="footerCommon"></footer>

  <dialog id="post-modal">
    <div class="modal-header">
      <strong id="modal-title">Post</strong>
      <button class="close-btn" id="close-modal" aria-label="Close">Close</button>
    </div>
    <div class="modal-body">
      <article class="prose" id="modal-body"></article>
    </div>
  </dialog>

  <script>
    // --- Configuration ---
    const DATA_URLS = [
      './data/posts.json', // preferred: create data/posts.json in your repo
      './posts.json'       // fallback
    ];

    // --- Helpers ---
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const escapeHTML = (s = '') =>
  s.replace(/[&<>"]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[m]));

    const minutesToRead = (text) => Math.max(1, Math.round(text.split(/\s+/).length / 200));
    const formatDate = (iso) => new Date(iso).toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });

    // Fallback posts so the page works even before you add posts.json
    const FALLBACK_POSTS = [
      {
        id: 'hair-patch-basics',
        title: 'What Is a Hair Patch? (Quick Guide)',
        date: '2025-08-10',
        tags: ['Hair Care','Non-surgical'],
        cover: 'https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?q=80&w=1200&auto=format&fit=crop',
        excerpt: 'A simple, non-surgical solution for localized hair loss. Here’s how it works and who it’s for.',
        content: `
          <p>A hair patch is a custom piece that blends with your existing hair to cover bald spots. It is attached using adhesive or clips and styled to match your natural look.</p>
          <h2>Key Benefits</h2>
          <ul>
            <li>Instant, natural-looking coverage</li>
            <li>Non-surgical and reversible</li>
            <li>Customisable size, density, and style</li>
          </ul>
          <p>Maintenance typically involves periodic servicing for re-bonding and grooming.</p>
        `
      },
      {
        id: 'hair-bonding-benefits',
        title: 'Hair Bonding: Pros, Care, and Myths',
        date: '2025-08-15',
        tags: ['Hair Care'],
        cover: 'https://images.unsplash.com/photo-1593702288056-7927c67b17a5?q=80&w=1200&auto=format&fit=crop',
        excerpt: 'Bonding offers a secure hold for patches and extensions. Learn how long it lasts and how to care for it.',
        content: `
          <p>Hair bonding uses medical-grade adhesive to attach a patch or weft to your scalp or hair. With proper care, bonding can last several weeks per session.</p>
          <p>Keep the scalp clean and avoid oil-heavy products near the bond line.</p>
        `
      }
    ];

    const state = { posts: [], tags: new Set() };

    async function loadPosts() {
      for (const url of DATA_URLS) {
        try {
          const res = await fetch(url, { cache: 'no-store' });
          if (res.ok) {
            const json = await res.json();
            if (Array.isArray(json)) return json;
            if (Array.isArray(json.posts)) return json.posts;
          }
        } catch (e) { /* try next */ }
      }
      return FALLBACK_POSTS;
    }

    function renderPosts(list) {
      const grid = $('#grid');
      grid.innerHTML = '';
      const tpl = $('#card-tpl');
      list.forEach(post => {
        const node = tpl.content.cloneNode(true);
        const img = node.querySelector('.thumb');
        const time = node.querySelector('.date');
        const read = node.querySelector('.read');
        const title = node.querySelector('.title');
        const excerpt = node.querySelector('.excerpt');
        const tags = node.querySelector('.tags');
        const open = node.querySelector('.open-modal');

        if (post.cover) {
          img.src = post.cover; img.alt = post.title || '';
        } else { img.remove(); }

        time.dateTime = post.date;
        time.textContent = formatDate(post.date);
        const plain = (post.content || '').replace(/<[^>]+>/g,' ');
        read.textContent = `${minutesToRead(post.excerpt || plain)} min read`;
        title.textContent = post.title || 'Untitled';
        excerpt.textContent = post.excerpt || plain.slice(0, 140) + '…';

        (post.tags || []).forEach(t => {
          const b = document.createElement('span');
          b.className = 'tag'; b.textContent = t; tags.appendChild(b);
          state.tags.add(t);
        });

        open.addEventListener('click', (e) => {
          e.preventDefault();
          openModal(post);
        });

        grid.appendChild(node);
      });

      // Populate tag filter
      const select = $('#filterTag');
      const current = select.value;
      select.innerHTML = '<option value="">All tags</option>' +
        Array.from(state.tags).sort().map(t => `<option value="${escapeHTML(t)}">${escapeHTML(t)}</option>`).join('');
      if (current) select.value = current;
    }

    function filterAndSearch() {
      const q = $('#search').value.trim().toLowerCase();
      const tag = $('#filterTag').value;
      const filtered = state.posts.filter(p => {
        const hay = `${p.title} ${p.excerpt} ${(p.tags||[]).join(' ')} ${(p.content||'').replace(/<[^>]+>/g,' ')}`.toLowerCase();
        const matchQ = !q || hay.includes(q);
        const matchTag = !tag || (p.tags||[]).includes(tag);
        return matchQ && matchTag;
      });
      renderPosts(filtered);
    }

    function openModal(post) {
      const dlg = document.getElementById('post-modal');
      document.getElementById('modal-title').textContent = post.title || 'Post';
      document.getElementById('modal-body').innerHTML = post.content || '<p>No content.</p>';
      if (typeof dlg.showModal === 'function') dlg.showModal(); else dlg.setAttribute('open','');
    }

    document.getElementById('close-modal').addEventListener('click', () => {
      const dlg = document.getElementById('post-modal');
      dlg.close ? dlg.close() : dlg.removeAttribute('open');
    });

    document.getElementById('search').addEventListener('input', filterAndSearch);
    document.getElementById('filterTag').addEventListener('change', filterAndSearch);

    document.getElementById('year').textContent = new Date().getFullYear();

    (async function init(){
      const posts = await loadPosts();
      // Sort newest first
      posts.sort((a,b) => (new Date(b.date)) - (new Date(a.date)));
      state.posts = posts;
      renderPosts(posts);
    })();
  </script>

  <!--
    QUICK START: Create data/posts.json with an array of posts, e.g.
    [
      {
        "id": "welcome",
        "title": "Welcome to the Fusion Blog",
        "date": "2025-08-25",
        "tags": ["Update"],
        "cover": "/assets/blog/welcome.jpg",
        "excerpt": "A quick intro to our new blog page.",
        "content": "<p>Hello! This is our blog. We'll share updates here.</p>"
      }
    ]
  -->
  <script>
    // Load header & footer like other pages and initialize menu
    document.addEventListener('DOMContentLoaded', function () {
      Promise.all([
        fetch('commonNav.html').then(r => r.text()),
        fetch('footer.html').then(r => r.text()),
      ]).then(([navHTML, footerHTML]) => {
        const nav = document.getElementById('commonNav');
        const footer = document.getElementById('footerCommon');
        if (nav) nav.outerHTML = navHTML;
        if (footer) footer.outerHTML = footerHTML;
        // Initialize menu plugins after nav is injected
        try { $('#menu').mmenu && $('#menu').mmenu(); } catch(e) {}
        try { $('.mh-head.first').mhead && $('.mh-head.first').mhead({ scroll: false }); } catch(e) {}
        try { $('.mh-head.second').mhead && $('.mh-head.second').mhead({ scroll: { hide: 200 } }); } catch(e) {}
        $(function(){ $('#menu').delay(200).fadeIn(150); });
      });
    });
  </script>
</body>
</html>
